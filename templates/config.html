{% extends "base.html" %}

{% block title %}Configuration - BioTrack-LeafTrade Middleware{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Configuration</h1>
            <p class="mt-2 text-gray-600">Manage API data synchronization and system settings</p>
        </div>



        <!-- Inventory Report - Featured Section -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 shadow-lg rounded-xl mb-8">
            <div class="px-6 py-4 border-b border-blue-200 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-t-xl">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h2 class="text-xl font-bold text-blue-900">üìä Full Inventory Report</h2>
                        <p class="text-sm text-blue-700 font-medium">Download comprehensive inventory data with lab test results</p>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900">BioTrack Inventory & Lab Data</h3>
                        <p class="text-sm text-gray-600 mt-1">Complete inventory report including room locations, quantities, and cannabinoid test results</p>
                        
                        <!-- Report Status Display -->
                        <div class="mt-3">
                            <div id="simple-inventory-status" class="text-sm">
                                <span id="simple-inventory-status-text">No report available</span>
                                <div id="simple-inventory-timestamp" class="text-xs text-gray-500 mt-1"></div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="mt-4">
                            <button id="simple-inventory-generate-btn" onclick="generateSimpleInventoryReport()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                üîÑ Generate Report
                            </button>
                            <button id="simple-inventory-download-btn" onclick="downloadSimpleInventoryReport()" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors hidden">
                                üì• Download Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Finished Goods Report - Connected to Inventory Report -->
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 shadow-lg rounded-xl mb-8">
            <div class="px-6 py-4 border-b border-green-200 bg-gradient-to-r from-green-100 to-emerald-100 rounded-t-xl">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h2 class="text-xl font-bold text-green-900">üè≠ Finished Goods Report</h2>
                        <p class="text-sm text-green-700 font-medium">Download QA-passed finished goods inventory with room filtering</p>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900">BioTrack Finished Goods & Lab Data</h3>
                        <p class="text-sm text-gray-600 mt-1">Filtered inventory report for QA-passed finished goods only</p>
                        
                        <!-- Report Status Display -->
                        <div class="mt-3">
                            <div id="simple-finished-goods-status" class="text-sm">
                                <span id="simple-finished-goods-status-text">No report available</span>
                                <div id="simple-finished-goods-timestamp" class="text-xs text-gray-500 mt-1"></div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="mt-4">
                            <button id="simple-finished-goods-generate-btn" onclick="generateSimpleFinishedGoodsReport()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                üîÑ Generate Report
                            </button>
                            <button id="simple-finished-goods-download-btn" onclick="downloadSimpleFinishedGoodsReport()" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors hidden">
                                üì• Download Report
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Concise Room Selection -->
                <div class="mt-6 pt-4 border-t border-green-200">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <h4 class="text-sm font-medium text-gray-700">Room Filter</h4>
                            <span id="room-count-badge" class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">
                                <span id="selected-room-count">0</span> selected
                            </span>
                        </div>
                        <button onclick="toggleRoomSelection()" id="room-toggle-btn" 
                                class="text-sm text-green-600 hover:text-green-800 font-medium flex items-center space-x-1">
                            <span>Configure Rooms</span>
                            <svg id="room-toggle-icon" class="w-4 h-4 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Collapsible Room Selection -->
                    <div id="room-selection-panel" class="hidden">
                        <div id="room-selection" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 mb-3">
                            <!-- Room checkboxes will be populated by JavaScript -->
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex space-x-2">
                                <button onclick="selectAllRooms()" class="text-xs text-blue-600 hover:text-blue-800 font-medium">Select All</button>
                                <button onclick="clearAllRooms()" class="text-xs text-gray-600 hover:text-gray-800 font-medium">Clear All</button>
                                <button onclick="refreshRoomList()" class="text-xs text-green-600 hover:text-green-800 font-medium">üîÑ Refresh</button>
                            </div>
                            <button onclick="saveRoomSelection()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs font-medium transition-colors">
                                üíæ Save
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Info -->
                    <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-md">
                        <p class="text-xs text-green-700">
                            <span class="font-medium">Includes:</span> QA-passed finished goods (Edibles, Extracts, Topicals, etc.) from selected rooms only
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Data Management -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">API Data Management</h2>
                <p class="text-sm text-gray-600 mt-1">Refresh cached data from external APIs</p>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Drivers Section -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Drivers (BioTrack)</h3>
                            <p class="text-sm text-gray-600">Manage driver data from BioTrack API</p>
                            <div class="mt-2 text-sm text-gray-500">
                                <span id="drivers-status">Loading status...</span>
                            </div>
                        </div>
                        <button id="refresh-drivers" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                            Refresh Drivers
                        </button>
                    </div>
                    <div id="drivers-result" class="mt-3 hidden">
                        <div class="text-sm p-3 rounded-md"></div>
                    </div>
                </div>

                <!-- Vehicles Section -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Vehicles (BioTrack)</h3>
                            <p class="text-sm text-gray-600">Manage vehicle data from BioTrack API</p>
                            <div class="mt-2 text-sm text-gray-500">
                                <span id="vehicles-status">Loading status...</span>
                            </div>
                        </div>
                        <button id="refresh-vehicles" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                            Refresh Vehicles
                        </button>
                    </div>
                    <div id="vehicles-result" class="mt-3 hidden">
                        <div class="text-sm p-3 rounded-md"></div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Orders (LeafTrade)</h3>
                            <p class="text-sm text-gray-600">Orders are fetched on-demand from LeafTrade API</p>
                            <div class="mt-2 text-sm text-gray-500">
                                <span id="orders-status">Real-time fetching</span>
                            </div>
                        </div>
                        <button disabled class="bg-gray-300 text-gray-500 px-4 py-2 rounded-md text-sm font-medium cursor-not-allowed">
                            Auto-fetch
                        </button>
                    </div>
                </div>

                <!-- Rooms Section -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Rooms (BioTrack)</h3>
                            <p class="text-sm text-gray-600">Manage room data from BioTrack API</p>
                            <div class="mt-2 text-sm text-gray-500">
                                <span id="rooms-status">Loading status...</span>
                            </div>
                        </div>
                        <button id="refresh-rooms" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                            Refresh Rooms
                        </button>
                    </div>
                    <div id="rooms-result" class="mt-3 hidden">
                        <div class="text-sm p-3 rounded-md"></div>
                    </div>
                </div>

                <!-- Vendors Section -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Vendors (BioTrack)</h3>
                            <p class="text-sm text-gray-600">Manage vendor data from BioTrack API</p>
                            <div class="mt-2 text-sm text-gray-500">
                                <span id="vendors-status">Loading status...</span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button id="refresh-vendors" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                Refresh Vendors
                            </button>
                            <button onclick="exportData('vendors')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                Export CSV
                            </button>
                        </div>
                    </div>
                    <div id="vendors-result" class="mt-3 hidden">
                        <div class="text-sm p-3 rounded-md"></div>
                    </div>
                </div>

                <!-- Customers Section -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Customers (LeafTrade)</h3>
                            <p class="text-sm text-gray-600">Manage customer location data from LeafTrade API</p>
                            <div class="mt-2 text-sm text-gray-500">
                                <span id="customers-status">Loading status...</span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button id="refresh-customers" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                Refresh Customers
                            </button>
                            <button onclick="exportData('customers')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                Export CSV
                            </button>
                        </div>
                    </div>
                    <div id="customers-result" class="mt-3 hidden">
                        <div class="text-sm p-3 rounded-md"></div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Training Mode Status -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">BioTrack Training Mode</h2>
                <p class="text-sm text-gray-600 mt-1">Current training mode status and configuration</p>
            </div>
            
            <div class="p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">
                            Current Mode: 
                            <span class="font-medium {% if is_training_mode %}text-yellow-600{% else %}text-red-600{% endif %}">
                                {% if is_training_mode %}Training{% else %}Production{% endif %}
                            </span>
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            Environment Variable: BIOTRACK_TRAINING_MODE={{ training_mode }}
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500">
                            To change mode, update the BIOTRACK_TRAINING_MODE<br>
                            environment variable and restart the application.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- BioTrack Data Refresh -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">BioTrack Data Management</h2>
                <p class="text-sm text-gray-600 mt-1">Manage BioTrack data with current training mode</p>
            </div>
            
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-4">
                    Current training mode: <span class="font-medium {% if is_training_mode %}text-yellow-600{% else %}text-red-600{% endif %}">
                        {% if is_training_mode %}Training{% else %}Production{% endif %}
                    </span>
                </p>
                <button onclick="refreshBiotrackData()" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium">
                    Refresh BioTrack Data
                </button>
                <p class="text-xs text-gray-500 mt-2">
                    This will clear existing data and refresh from BioTrack using the current training mode.
                </p>
            </div>
        </div>

        <!-- System Information -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">System Information</h2>
                <p class="text-sm text-gray-600 mt-1">Current system status and configuration</p>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-3">Database Status</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Database Type:</span>
                                <span class="font-medium">PostgreSQL</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Migration Status:</span>
                                <span class="font-medium text-green-600">Up to date</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-3">API Connections</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">BioTrack API:</span>
                                <span id="biotrack-status" class="font-medium text-gray-500">Manual Check Required</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">LeafTrade API:</span>
                                <span id="leaftrade-status" class="font-medium text-gray-500">Manual Check Required</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load initial status
    loadStatus();
    
    // Load room selection
    loadRoomSelection();
    
    // Set up refresh buttons
    document.getElementById('refresh-drivers').addEventListener('click', function() {
        refreshData('drivers');
    });
    
    document.getElementById('refresh-vehicles').addEventListener('click', function() {
        refreshData('vehicles');
    });
    
    document.getElementById('refresh-rooms').addEventListener('click', function() {
        refreshData('rooms');
    });
    
    document.getElementById('refresh-vendors').addEventListener('click', function() {
        refreshData('vendors');
    });
    
    document.getElementById('refresh-customers').addEventListener('click', function() {
        refreshData('customers');
    });
    
    // Load simplified report status on page load
    checkSimpleReportStatus();
});

function refreshBiotrackData() {
    const button = event.target;
    const originalText = button.textContent;
    
    // Disable button and show loading
    button.disabled = true;
    button.textContent = 'Refreshing...';
    button.className = 'bg-gray-400 text-white px-4 py-2 rounded text-sm font-medium cursor-not-allowed';
    
    // Show confirmation dialog
    if (!confirm('This will clear all existing BioTrack data and refresh from the current training mode environment. Continue?')) {
        // Re-enable button if cancelled
        button.disabled = false;
        button.textContent = originalText;
        button.className = 'bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium';
        return;
    }
    
    // Make API call to refresh all BioTrack data
    fetch('/api/biotrack/refresh', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('BioTrack data refreshed successfully!');
            // Reload status
            loadStatus();
        } else {
            alert('Error refreshing BioTrack data: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Network error occurred while refreshing BioTrack data');
    })
    .finally(() => {
        // Re-enable button
        button.disabled = false;
        button.textContent = originalText;
        button.className = 'bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium';
    });
}

function loadStatus() {
    // Load drivers status
    fetch('/api/drivers')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('drivers-status');
            if (data.drivers) {
                statusElement.textContent = `${data.drivers.length} drivers cached`;
                statusElement.className = 'text-sm text-green-600';
            } else {
                statusElement.textContent = 'No drivers cached';
                statusElement.className = 'text-sm text-yellow-600';
            }
        })
        .catch(error => {
            document.getElementById('drivers-status').textContent = 'Error loading status';
            document.getElementById('drivers-status').className = 'text-sm text-red-600';
        });
    
    // Load vehicles status
    fetch('/api/vehicles')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('vehicles-status');
            if (data.vehicles) {
                statusElement.textContent = `${data.vehicles.length} vehicles cached`;
                statusElement.className = 'text-sm text-green-600';
            } else {
                statusElement.textContent = 'No vehicles cached';
                statusElement.className = 'text-sm text-yellow-600';
            }
        })
        .catch(error => {
            document.getElementById('vehicles-status').textContent = 'Error loading status';
            document.getElementById('vehicles-status').className = 'text-sm text-red-600';
        });
    
    // Load rooms status
    fetch('/api/rooms')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('rooms-status');
            if (data.rooms) {
                statusElement.textContent = `${data.rooms.length} rooms cached`;
                statusElement.className = 'text-sm text-green-600';
            } else {
                statusElement.textContent = 'No rooms cached';
                statusElement.className = 'text-sm text-yellow-600';
            }
        })
        .catch(error => {
            document.getElementById('rooms-status').textContent = 'Error loading status';
            document.getElementById('rooms-status').className = 'text-sm text-red-600';
        });
    
    // Load vendors status
    fetch('/api/vendors')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('vendors-status');
            if (data.vendors) {
                statusElement.textContent = `${data.vendors.length} vendors cached`;
                statusElement.className = 'text-sm text-green-600';
            } else {
                statusElement.textContent = 'No vendors cached';
                statusElement.className = 'text-sm text-yellow-600';
            }
        })
        .catch(error => {
            document.getElementById('vendors-status').textContent = 'Error loading status';
            document.getElementById('vendors-status').className = 'text-sm text-red-600';
        });
    
    // Load customers status
    fetch('/api/customers')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('customers-status');
            if (data.customers) {
                statusElement.textContent = `${data.customers.length} customers cached`;
                statusElement.className = 'text-sm text-green-600';
            } else {
                statusElement.textContent = 'No customers cached';
                statusElement.className = 'text-sm text-yellow-600';
            }
        })
        .catch(error => {
            document.getElementById('customers-status').textContent = 'Error loading status';
            document.getElementById('customers-status').className = 'text-sm text-red-600';
        });
    
    // Note: API connections are checked manually via refresh buttons
    // No automatic API calls are made
}

function refreshData(type) {
    const button = document.getElementById(`refresh-${type}`);
    const resultDiv = document.getElementById(`${type}-result`);
    const resultContent = resultDiv.querySelector('div');
    
    // Disable button and show loading
    button.disabled = true;
    button.textContent = 'Refreshing...';
    button.className = 'bg-gray-400 text-white px-4 py-2 rounded-md text-sm font-medium cursor-not-allowed';
    
    // Show result area
    resultDiv.classList.remove('hidden');
    resultContent.textContent = 'Refreshing data...';
    resultContent.className = 'text-sm p-3 rounded-md bg-blue-50 text-blue-800';
    
    // Make API call
    fetch(`/api/${type}/refresh`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultContent.textContent = data.message;
            resultContent.className = 'text-sm p-3 rounded-md bg-green-50 text-green-800';
            // Reload status
            loadStatus();
        } else {
            resultContent.textContent = data.error || 'Failed to refresh data';
            resultContent.className = 'text-sm p-3 rounded-md bg-red-50 text-red-800';
        }
    })
    .catch(error => {
        resultContent.textContent = 'Network error occurred';
        resultContent.className = 'text-sm p-3 rounded-md bg-red-50 text-red-800';
    })
    .finally(() => {
        // Re-enable button
        button.disabled = false;
        button.textContent = `Refresh ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        button.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors';
        
        // Hide result after 5 seconds
        setTimeout(() => {
            resultDiv.classList.add('hidden');
        }, 5000);
    });
}

// API connections are checked manually via refresh buttons
// No automatic API calls are made to prevent unwanted API usage

function exportData(type) {
    // Simple CSV export by navigating to the export endpoint
    window.location.href = `/api/${type}/export`;
}



document.addEventListener('DOMContentLoaded', function() {
    // Set up form submission
});

// Finished Goods Report Functions
async function loadRoomSelection() {
    try {
        // Load available rooms
        const roomsResponse = await fetch('/api/rooms');
        const roomsData = await roomsResponse.json();
        
        // Load selected rooms
        const selectedResponse = await fetch('/api/global-preferences/rooms');
        const selectedData = await selectedResponse.json();
        const selectedRooms = selectedData.selected_rooms || [];
        
        // Populate room checkboxes
        const roomContainer = document.getElementById('room-selection');
        roomContainer.innerHTML = '';
        
        if (roomsData.rooms && roomsData.rooms.length > 0) {
            // Sort rooms alphabetically by name
            const sortedRooms = roomsData.rooms.sort((a, b) => a.name.localeCompare(b.name));
            
            sortedRooms.forEach(room => {
                const isSelected = selectedRooms.includes(room.id.toString());
                const checkbox = document.createElement('div');
                checkbox.className = 'flex items-center space-x-2';
                checkbox.innerHTML = `
                    <input type="checkbox" 
                           id="room-${room.id}" 
                           value="${room.id}" 
                           ${isSelected ? 'checked' : ''}
                           class="rounded border-gray-300 text-green-600 focus:ring-green-500"
                           onchange="updateRoomCount(); markAsUnsaved();">
                    <label for="room-${room.id}" class="text-sm text-gray-700">${room.name}</label>
                `;
                roomContainer.appendChild(checkbox);
            });
        } else {
            roomContainer.innerHTML = '<p class="text-gray-500 text-sm">No rooms available. Please refresh BioTrack data first.</p>';
        }
        
        // Update room count after loading
        updateRoomCount();
    } catch (error) {
        document.getElementById('room-selection').innerHTML = '<p class="text-red-500 text-sm">Error loading rooms</p>';
        updateRoomCount();
    }
}

async function saveRoomSelection() {
    const saveButton = event.target;
    const originalText = saveButton.textContent;
    
    // Disable button and show loading
    saveButton.disabled = true;
    saveButton.textContent = 'Saving...';
    saveButton.className = 'bg-gray-400 text-white px-3 py-1 rounded text-sm font-medium cursor-not-allowed';
    
    try {
        const checkboxes = document.querySelectorAll('#room-selection input[type="checkbox"]:checked');
        const selectedRooms = Array.from(checkboxes).map(cb => cb.value);
        
        const response = await fetch('/api/global-preferences/rooms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ selected_rooms: selectedRooms })
        });
        
        const result = await response.json();
        if (result.success) {
            document.getElementById('finished-goods-status').textContent = `Room selection saved (${selectedRooms.length} rooms selected)`;
            document.getElementById('finished-goods-status').className = 'text-sm text-green-600';
        } else {
            throw new Error(result.error || 'Failed to save room selection');
        }
    } catch (error) {
        document.getElementById('finished-goods-status').textContent = 'Error saving room selection';
        document.getElementById('finished-goods-status').className = 'text-sm text-red-600';
    } finally {
        // Re-enable button
        saveButton.disabled = false;
        saveButton.textContent = originalText;
        saveButton.className = 'bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors';
    }
}

function selectAllRooms() {
    const checkboxes = document.querySelectorAll('#room-selection input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = true);
    updateRoomCount();
    markAsUnsaved();
}

function clearAllRooms() {
    const checkboxes = document.querySelectorAll('#room-selection input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    updateRoomCount();
    markAsUnsaved();
}

function refreshRoomList() {
    loadRoomSelection();
}

function markAsUnsaved() {
    // Update status to show unsaved changes
    document.getElementById('finished-goods-status').textContent = 'Changes not saved - click Save Selection';
    document.getElementById('finished-goods-status').className = 'text-sm text-orange-600';
}

function toggleRoomSelection() {
    const panel = document.getElementById('room-selection-panel');
    const icon = document.getElementById('room-toggle-icon');
    const btn = document.getElementById('room-toggle-btn');
    
    if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        icon.classList.add('rotate-180');
        btn.querySelector('span').textContent = 'Hide Rooms';
    } else {
        panel.classList.add('hidden');
        icon.classList.remove('rotate-180');
        btn.querySelector('span').textContent = 'Configure Rooms';
    }
}

function updateRoomCount() {
    const checkboxes = document.querySelectorAll('#room-selection input[type="checkbox"]:checked');
    const count = checkboxes.length;
    document.getElementById('selected-room-count').textContent = count;
    
    // Update badge color based on count
    const badge = document.getElementById('room-count-badge');
    if (count === 0) {
        badge.className = 'px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded-full';
    } else {
        badge.className = 'px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full';
    }
}

// Simplified Report Generation Functions

async function checkSimpleReportStatus() {
    try {
        // Check inventory report status
        const inventoryResponse = await fetch('/api/inventory-report/status-simple');
        const inventoryData = await inventoryResponse.json();
        updateSimpleInventoryUI(inventoryData);
        
        // Check finished goods report status
        const finishedGoodsResponse = await fetch('/api/finished-goods-report/status-simple');
        const finishedGoodsData = await finishedGoodsResponse.json();
        updateSimpleFinishedGoodsUI(finishedGoodsData);
    } catch (error) {
        // Silent error handling
    }
}

function updateSimpleInventoryUI(data) {
    const statusText = document.getElementById('simple-inventory-status-text');
    const timestampDiv = document.getElementById('simple-inventory-timestamp');
    const generateBtn = document.getElementById('simple-inventory-generate-btn');
    const downloadBtn = document.getElementById('simple-inventory-download-btn');
    
    if (data.status === 'ready' && data.download_available) {
        statusText.textContent = '‚úÖ Report ready for download';
        statusText.className = 'text-sm text-green-600';
        timestampDiv.textContent = `Last generated: ${formatSimpleTimestamp(data.timestamp)}`;
        generateBtn.disabled = false;
        generateBtn.textContent = 'üîÑ Refresh Report';
        generateBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors';
        generateBtn.classList.remove('hidden');
        downloadBtn.classList.remove('hidden');
    } else if (data.status === 'generating') {
        statusText.textContent = 'üîÑ Report is being generated...';
        statusText.className = 'text-sm text-blue-600';
        timestampDiv.textContent = '';
        generateBtn.disabled = true;
        generateBtn.textContent = '‚è≥ Generating...';
        generateBtn.className = 'bg-gray-400 text-white px-4 py-2 rounded text-sm font-medium cursor-not-allowed';
        downloadBtn.classList.add('hidden');
    } else {
        statusText.textContent = 'üìä No report available';
        statusText.className = 'text-sm text-gray-600';
        timestampDiv.textContent = '';
        generateBtn.disabled = false;
        generateBtn.textContent = 'üîÑ Generate Report';
        generateBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors';
        downloadBtn.classList.add('hidden');
    }
}

function updateSimpleFinishedGoodsUI(data) {
    const statusText = document.getElementById('simple-finished-goods-status-text');
    const timestampDiv = document.getElementById('simple-finished-goods-timestamp');
    const generateBtn = document.getElementById('simple-finished-goods-generate-btn');
    const downloadBtn = document.getElementById('simple-finished-goods-download-btn');
    
    if (data.status === 'ready' && data.download_available) {
        statusText.textContent = '‚úÖ Report ready for download';
        statusText.className = 'text-sm text-green-600';
        timestampDiv.textContent = `Last generated: ${formatSimpleTimestamp(data.timestamp)}`;
        generateBtn.disabled = false;
        generateBtn.textContent = 'üîÑ Refresh Report';
        generateBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors';
        generateBtn.classList.remove('hidden');
        downloadBtn.classList.remove('hidden');
    } else if (data.status === 'generating') {
        statusText.textContent = 'üîÑ Report is being generated...';
        statusText.className = 'text-sm text-blue-600';
        timestampDiv.textContent = '';
        generateBtn.disabled = true;
        generateBtn.textContent = '‚è≥ Generating...';
        generateBtn.className = 'bg-gray-400 text-white px-4 py-2 rounded text-sm font-medium cursor-not-allowed';
        downloadBtn.classList.add('hidden');
    } else {
        statusText.textContent = 'üìä No report available';
        statusText.className = 'text-sm text-gray-600';
        timestampDiv.textContent = '';
        generateBtn.disabled = false;
        generateBtn.textContent = 'üîÑ Generate Report';
        generateBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors';
        downloadBtn.classList.add('hidden');
    }
}

async function generateSimpleInventoryReport() {
    const generateBtn = document.getElementById('simple-inventory-generate-btn');
    const statusText = document.getElementById('simple-inventory-status-text');
    
    try {
        // Update button state immediately
        generateBtn.disabled = true;
        generateBtn.textContent = '‚è≥ Starting...';
        generateBtn.className = 'bg-gray-400 text-white px-4 py-2 rounded text-sm font-medium cursor-not-allowed';
        
        // Update status display
        statusText.textContent = 'üöÄ Starting report generation...';
        statusText.className = 'text-sm text-blue-600';
        
        const response = await fetch('/api/inventory-report/generate-simple', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        if (data.success) {
            statusText.textContent = 'üîÑ Report generation started...';
            statusText.className = 'text-sm text-blue-600';
            generateBtn.textContent = '‚è≥ Generating...';
            
            // Start simple polling
            pollSimpleInventoryStatus();
        } else {
            // Reset button on error
            generateBtn.disabled = false;
            generateBtn.textContent = 'üîÑ Generate Report';
            generateBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors';
            statusText.textContent = '‚ùå Error: ' + data.error;
            statusText.className = 'text-sm text-red-600';
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        // Reset button on error
        generateBtn.disabled = false;
        generateBtn.textContent = 'üîÑ Generate Report';
        generateBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors';
        statusText.textContent = '‚ùå Error generating report';
        statusText.className = 'text-sm text-red-600';
        showToast('Error generating report', 'error');
    }
}

async function generateSimpleFinishedGoodsReport() {
    const generateBtn = document.getElementById('simple-finished-goods-generate-btn');
    const statusText = document.getElementById('simple-finished-goods-status-text');
    
    try {
        // Update button state immediately
        generateBtn.disabled = true;
        generateBtn.textContent = '‚è≥ Starting...';
        generateBtn.className = 'bg-gray-400 text-white px-4 py-2 rounded text-sm font-medium cursor-not-allowed';
        
        // Update status display
        statusText.textContent = 'üöÄ Starting report generation...';
        statusText.className = 'text-sm text-blue-600';
        
        const response = await fetch('/api/finished-goods-report/generate-simple', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        if (data.success) {
            statusText.textContent = 'üîÑ Report generation started...';
            statusText.className = 'text-sm text-blue-600';
            generateBtn.textContent = '‚è≥ Generating...';
            
            // Start simple polling
            pollSimpleFinishedGoodsStatus();
        } else {
            // Reset button on error
            generateBtn.disabled = false;
            generateBtn.textContent = 'üîÑ Generate Report';
            generateBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors';
            statusText.textContent = '‚ùå Error: ' + data.error;
            statusText.className = 'text-sm text-red-600';
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        // Reset button on error
        generateBtn.disabled = false;
        generateBtn.textContent = 'üîÑ Generate Report';
        generateBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors';
        statusText.textContent = '‚ùå Error generating report';
        statusText.className = 'text-sm text-red-600';
        showToast('Error generating report', 'error');
    }
}

function pollSimpleInventoryStatus() {
    const interval = setInterval(async () => {
        try {
            const response = await fetch('/api/inventory-report/status-simple');
            const data = await response.json();
            updateSimpleInventoryUI(data);
            
            if (data.status === 'ready' || data.status === 'error') {
                clearInterval(interval);
            }
        } catch (error) {
            clearInterval(interval);
        }
    }, 3000); // Poll every 3 seconds
}

function pollSimpleFinishedGoodsStatus() {
    const interval = setInterval(async () => {
        try {
            const response = await fetch('/api/finished-goods-report/status-simple');
            const data = await response.json();
            updateSimpleFinishedGoodsUI(data);
            
            if (data.status === 'ready' || data.status === 'error') {
                clearInterval(interval);
            }
        } catch (error) {
            clearInterval(interval);
        }
    }, 3000); // Poll every 3 seconds
}

function downloadSimpleInventoryReport() {
    window.location.href = '/api/inventory-report/download-simple';
}

function downloadSimpleFinishedGoodsReport() {
    window.location.href = '/api/finished-goods-report/download-simple';
}

function formatSimpleTimestamp(timestamp) {
    if (!timestamp) return '';
    try {
        const date = new Date(timestamp);
        return date.toLocaleString();
    } catch (error) {
        return timestamp;
    }
}

function showToast(message, type) {
    // Create a simple toast notification
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-md text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        document.body.removeChild(toast);
    }, 3000);
}
</script>
{% endblock %} 